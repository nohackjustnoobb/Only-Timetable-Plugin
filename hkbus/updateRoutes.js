var i=(()=>{try{return!!(navigator&&navigator.userAgent&&navigator.userAgent.includes("Safari/")&&!(navigator.userAgent.includes("Chrome/")||navigator.userAgent.includes("Chromium/")))}catch{return!1}})();var ne=new Intl.DateTimeFormat("en-US",{hourCycle:"h23",timeZone:"America/New_York",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(new Date("2014-06-25T04:00:00.123Z"));var pe=60*1e3;async function y(){return fetch("https://data.hkbus.app/routeFareList.min.json",{cache:"no-store"}).then(t=>t.json()).catch(()=>fetch("https://hkbus.github.io/hk-bus-crawling/routeFareList.min.json",{cache:"no-store"}).then(t=>t.json()))}async function I(t){await sendMessage("saveRoutes",t.map(e=>(e.meta&&(e.meta=JSON.stringify(e.meta)),e.source&&(e.source=JSON.stringify(e.source)),e)))}async function O(t){await sendMessage("saveStops",t.map(e=>(e.name&&(e.name=JSON.stringify(e.name)),e.meta&&(e.meta=JSON.stringify(e.meta)),e)))}async function x(t){let e=await sendMessage("getValue",t);return e??null}async function p(t,e){await sendMessage("setValue",t,e)}var U=24*60*60*1e3;async function Y(){let t=await x("lastUpdate");if(t&&Date.now()-Number(t)<U)return;let e=await y(),T=[];for(let[n,r]of Object.entries(e.stopList)){let o={id:n,name:r.name,lat:r.location.lat,long:r.location.lng,meta:e.stopMap[n]};T.push(o)}await O(T);let l={};for(let[n,r]of Object.entries(e.stopMap)){if(!e.stopList[n])throw new Error(`Invalid stop ID: ${n}`);for(let[o,c]of r)l[o]||(l[o]={}),l[o][c]=n}let S=(n,r)=>[n,r.map(o=>{if(l[n][o])return l[n][o];if(e.stopList[o])return o;throw new Error(`Invalid stop ID: ${o} for company: ${n}`)})],D=[];for(let[n,r]of Object.entries(e.routeList)){let o=Object.entries(r.stops).map(([u,a])=>S(u,a)),c={};for(let[u,a]of o){let h=r.bound[u],s=JSON.stringify({stops:a,bound:h});c[s]||(c[s]=[]),c[s].push(u)}for(let[u,a]of Object.entries(c)){let h=JSON.parse(u),s=h.stops,N=h.bound,f=JSON.parse(JSON.stringify(r));f.co=a,f.bound=Object.fromEntries(a.map(m=>[m,f.bound[m]])),f.stops=Object.fromEntries(a.map(m=>[m,f.stops[m]]));let w=r.route;Number(r.serviceType)>1&&(w+=" \u20F0");let $={id:`${n}+${a.join("+")}+${N}`,displayId:w,name:[...Object.values(r.orig),...Object.values(r.dest)].join("+"),source:{en:a.join(" / ").toLocaleUpperCase()},orig:s[0],dest:s[s.length-1],stops:s,meta:f};D.push($)}}await I(D),await p("serviceDayMap",JSON.stringify(e.serviceDayMap)),await p("holidays",JSON.stringify(e.holidays)),await p("stopList",JSON.stringify(e.stopList)),await p("lastUpdate",String(Date.now()))}var yt=Y;export{yt as default};
